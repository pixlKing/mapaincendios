<!DOCTYPE html>
<html>
<head>
	<title>test</title>
	<script  src="https://code.jquery.com/jquery-3.4.1.min.js"  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="  crossorigin="anonymous"></script>
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>

	<div class="container">
		<div id="container-mapaincendio---Main--mapContainer" style="height:800px; width:100%"></div>
	</div>

	<script type="text/javascript">
		var TORRES;
		var INCENDIOS;
		var TORRES_NEW = [];
		$.ajax({ url: "torres.json"   }).done(function(data) {

			TORRES = data;

			$.ajax({ url: "incendios.json" }).done(function(data) {

				INCENDIOS = data;
				console.log(INCENDIOS);

				$.each( TORRES.features, function( indexTorre, torre ) {
					var torreX = torre.geometry.coordinates[0];
					var torreY = torre.geometry.coordinates[1];
					var TEMP = [];

					$.each( INCENDIOS.features, function( indexIncendio, incendio ) {
						var incendioX = incendio.geometry.coordinates[0];
						var incendioY = incendio.geometry.coordinates[1];
						var probability = incendio.properties.foiPredictionScore;
						var DistanceBetweenPoints = getDistanceBetweenPoints(torreX,torreY,  incendioX,incendioY);
						var textColor = getTextColor(probability);


						TEMP.push({
							"geometry": {
								"type": "Point",
								"coordinates": [ torreX, torreY ]
							},
							"type": "Feature",
							"properties": {
								"textColor": textColor,
								"DistanceBetweenPoints": DistanceBetweenPoints,
								"foiPredictionScore": probability
							}
						});


					});

					var nearestFireFocus = TEMP.reduce(function(res, obj) {
						return (obj.properties.DistanceBetweenPoints < res.properties.DistanceBetweenPoints) ? obj : res;
					});

					TORRES_NEW.push(nearestFireFocus);

					console.log(TEMP);
					console.log(nearestFireFocus);

				});

				console.log("Nuevo json mergeado de torres con la probabilidad mas cercana: ");
				console.log(TORRES_NEW);
				createMapLayer(TORRES_NEW);
			});
		});

		function getTextColor(value){
			//Create a color range based on value
			// ColorRange
			var critical = "#ff0000";//red
			var medium 	 = "#ff5500";//orange
			var low 	 = "#ffff00";//yellow

			if(value > 80){
				return critical
			}else if( value >= 50 && value <= 80 ){
				return medium
			}else {
				return low
			}
		}

		function createMapLayer(dataMap){
			console.log("dataMap: ");
			console.log(dataMap);
			mapboxgl.accessToken = 'pk.eyJ1IjoibWF0dGNhbXBhIiwiYSI6ImNqeWlzZWx3dTBkcm8zZHA1czJ4bnNuamQifQ.XZwmyx7JwQ0RLIgQlpJb1g';
			var map = new mapboxgl.Map({
				container: 'container-mapaincendio---Main--mapContainer',
				style: 'mapbox://styles/mapbox/streets-v11',
				center: [-60.90173,-33.30103],
				zoom: 6
			});

			map.on('load', function () {
				map.addLayer(
					{
						"id": "heatmapPoints",
						"type": "symbol",
						"source": {
							"type": "geojson",
							"data": {
							    "type": "FeatureCollection",
							    "features": dataMap
							}
						},
						"layout": {
							"text-field": "{foiPredictionScore}",
							"text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
							"text-offset": [0, 0.6],
							"text-anchor": "top"
						},
						"paint": {
							"text-color": ['get', 'textColor'],
							"text-halo-color": "#000000",
							"text-halo-width": 3
						}
					}
				)
			});

		}

		function getDistanceBetweenPoints(p1_X, p1_Y, p2_X, p2_Y){
			//calculo catetos
			var catetoX = p2_X - p1_X;
			var catetoY = p2_Y - p1_Y;
			//calculo hipotenusa
			var hipo = Math.sqrt(Math.pow(catetoX, 2) + Math.pow(catetoY, 2));

			return hipo;
		}

	</script>
	<!-- <script src='map.js'></script> -->

</body>
</html>